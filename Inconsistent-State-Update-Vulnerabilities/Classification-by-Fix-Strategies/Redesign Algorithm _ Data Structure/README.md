## Redesign Algorithm/Data Structure
Redesign Algorithm/Data Structure (23.28%).
|Serial number| Reporting time |  Bug link  | Root cause | Exploitation method | Fix strategy  |
|    :---:    |      :---:     |    :---:    |      :---:     |      :---:     |      :---:     |
|1|2021-05-03|[2021-04-marginswap#h-07](https://code4rena.com/reports/2021-04-marginswap#h-07-accountholdstoken-is-never-set)| There is a lack of mapping to avoid repeatedly depositing the same token. | Multiple deposits of the same token resulted in duplicate token records in the account. holdingTokens array. | Set the holdsToken map in addHolding() to distinguish different tokens.
|2|2021-08-17|[2021-07-wildcredit#h-02](https://code4rena.com/reports/2021-07-wildcredit#h-02-lendingpairliquidateaccount-does-not-accrue-and-update-cumulativeinterestrate)| The accumulated interest rate is not updated during account liquidation.| Interest calculation error, the borrower bypassed interest payment through self liquidation. | Revise the previous accumulated interest rate update method.
|3|2022-01-21|[2021-11-bootfinance#h-03](https://code4rena.com/reports/2021-11-bootfinance#h-03-swaputilssol-wrong-implementation)| The tokenPrecisionMultipliers used in price calculations is not computed in real-time.| The attacker use old tokenPrecision Multipliers for transactions before the target price takes effect. | Change tokenPrecisionMultipliers to real-time calculation.
|4|2023-03-07|[2021-12-amun#h-01](https://code4rena.com/reports/2021-12-amun#h-01-unused-erc20-tokens-are-not-refunded-and-can-be-stolen-by-attacker)|The remaining tokens are not refunded. | Incorrect calculation and refund of remaining underlying tokens. | Calculate and trade only the required token amount, then refund any remaining tokens to the user after the transaction.
|5|2022-10-26|[2022-08-olympus#h-03](https://code4rena.com/reports/2022-08-olympus#h-03-trsry-front-runnable-setapprovalfor)|The current allowance is not decremented based on existing withdrawal records. | The attacker can front-run the approval change process to withdraw the previously approved funds early. | Decrement the current allowance based on existing withdrawal records when setting a new allowance.
|6|2023-01-31|[2022-12-backed#h-01](https://code4rena.com/reports/2022-12-backed#h-01-borrowers-may-earn-auction-proceeds-without-filling-the-debt-shortfall)| The variable for accumulating and storing the remaining debt after each auction is lacking. | The debt was not properly liquidated, resulting in the auction proceeds going directly to the borrower. | Increase the record of the debt gap through the newly added _shortfall variable.
|7|2023-03-21|[2022-12-gogopool#h-01](https://code4rena.com/reports/2022-12-gogopool#h-01-avax-assigned-high-water-is-updated-incorrectly)| The maximum AVAX allocation per node in the cycle is increased via the increaseAVAXAssignedHighWater() function, rather than being directly updated to the current AVAXAssigned value. | The attacker manipulates AVAX higher than the actual allocation to obtain more rewards. | Change the previous cumulative update method to directly update to the current AVAXAssigned value.
|8|2023-04-11|[2023-03-neotokyo#h-01](https://code4rena.com/reports/2023-03-neotokyo#h-01-updating-a-pools-total-points-doesnt-affect-existing-stake-positions-for-rewards-calculation)| There is a lack of variables for tracking the reward distribution of each point. | The reward calculation did not correctly reflect the changes in the total points of the pool, affecting the user's rewards. | Introduce the rewardPerTokenStored variable to track the reward distribution for each point.
|9|2023-04-11|[2023-01-rabbithole#h-02](https://code4rena.com/reports/2023-01-rabbithole#h-02-protocol-fees-can-be-withdrawn-multiple-times-in-erc20quest)|The fee withdrawal status is not updated. | The withdrawFee() function does not have any protection mechanism, allowing the protocol fee to be withdrawn multiple times. | Track the protocol fee withdrawal status.
|10|2023-04-18|[2022-12-tessera#h-06](https://code4rena.com/reports/2022-12-tessera#h-06-funds-are-permanently-stuck-in-optimisticlistingseaportsol-contract-if-active-proposal-is-executed-after-new-proposal-is-pending)| The propose() function overwrites the hash of the currently active proposal. | When an activated proposal is executed while a new proposal is pending, funds are permanently stuck in the contract. | Add an orderHash field to the Listing struct to ensure active and new proposals maintain distinct hash values.
|11|2023-04-27|[2023-03-mute#h-01](https://code4rena.com/reports/2023-03-mute#h-01-bond-max-buyer-might-end-up-buying-the-max-buy-of-the-next-epoch)| A variable for tracking the current period number is missing. | max_buy was miscalculated, causing users to incorrectly buy the next period's worth of bonds at a lower price than expected. | Add a variable "currentEpoch" to track the current cycle number.
|12|2023-05-01|[2023-02-malt#h-01](https://code4rena.com/reports/2023-02-malt#h-01-rewardthrottlecheckrewardunderflow-might-track-the-cumulative-aprs-wrongly)| The _sendToDistributor() function early returns if amount == 0. | The cumulative APR was not calculated correctly, affecting the target APR calculation in updateDesiredAPR(). | Add conditions and modify the logic in _sendToDistributor() to update the current epoch's cumulative APR with the previous epoch's APR value when the amount is zero.
|13|2023-06-23|[2023-05-party#h-01](https://code4rena.com/reports/2023-05-party#h-01-the-distribution-logic-will-be-broken-after-calling-ragequit)| Calculate the allocation ratio for each faction's NFTs based on the current totalVotingPower. | The usersâ€™ allocation shares were miscalculated, allowing the attacker to obtain more funds than they deserved by destroying NFTs. | Do not use dynamic totalVotingPower for allocation. Instead, record the initial totalVotingPower at the time of each distribution.
|14|2023-06-23|[2023-04-party#h-08](https://code4rena.com/reports/2023-04-party#h-08-vetoproposal-user-can-veto-multiple-times-so-every-proposal-can-be-vetoed-by-any-user-that-has-a-small-amount-of-votes)| A mapping for tracking whether a veto vote has been cast is missing. | Users can vote down the same proposal multiple times, allowing users with a small number of votes to veto any proposal. | Add a hasVoted map to track whether each (party, proposalId, address) triple has already cast a veto vote.
|15|2023-08-01|[2023-03-polynomial#h-01](https://code4rena.com/reports/2023-03-polynomial#h-01-exchange_liquidate-function-can-cause-liquidator-to-burn-too-much-powerperp-tokens)|The update to totalCollateralReturned is missing. | Liquidators burn excessive powerPerp tokens, resulting in a loss of funds. | Calculate the token amount corresponding to the collateral actually received by the liquidator, then match the burned token quantity with the liquidator's actual received collateral value.
|16|2023-08-07|[2023-05-particle#h-06](https://code4rena.com/reports/2023-05-particle#h-06-marketplace-may-call-onerc721received-and-create-a-lien-during-buynftfrommarket-creating-divergence)| There is a lack of a flag for indicating that the purchase operation of the contract is underway. | onERC721Received() creates two pledge rights in the intermediate state, resulting in the same NFT being bound to two different pledge rights. | Set a _marketBuyFlow flag to indicate that the contract is conducting a market purchase operation.
|17|2023-08-21|[2023-06-lybra#h-02](https://code4rena.com/reports/2023-06-lybra#h-02-doesnt-calculate-the-current-borrowing-amount-for-the-provider-including-the-providers-borrowed-shares-and-accumulated-fees-due-to-inconsistency-in-collateralratio-calculation)| The liquidation() and rigidRedemption() functions calculate collateralRatio differently. | Bypass the correct mortgage rate calculation by calculating only the principal amount borrowed and ignoring the share of the borrowing and accumulated fees. | Modify the collateralRatio calculation method in the rigidRedemption() function.
|18|2023-11-16|[2023-07-tapioca#h-20](https://code4rena.com/reports/2023-07-tapioca#h-20-_liquidateuser-should-not-re-use-the-same-minimum-swap-amount-out-for-multiple-liquidation)| When liquidate() performs clearing operations for multiple users, it uses the same minAssetAmount value and lacks variables for different records. | The liquidation amount was inaccurate, resulting in losses to both the liquidator and the agreement. | Modify the liquidate() function to enable liquidators to pass multiple minAssetAmount parameter values, so that each value corresponds to a different borrower.
|19|2024-03-20|[2024-01-renft#h-07](https://code4rena.com/reports/2024-01-renft#h-07-attacker-can-lock-lender-nfts-and-erc20-in-the-safe-if-the-offer-is-set-to-partial)| Different hash values corresponding to different orders are lacking. | Creating multiple similar partially filled orders results in the same order hash value, which allows the partial asset to be locked. | Introduce a random number (nonce) for each order to ensure that the orderHash is unique.
|20|2024-05-14|[2024-02-ai-arena#h-07](https://code4rena.com/reports/2024-02-ai-arena#h-07-fighters-cannot-be-minted-after-the-initial-generation-due-to-uninitialized-numelements-mapping)| In the constructor, only the 0th Generation (Generation 0) is initialized as 3, while subsequent generations (Generation 1, Generation 2, etc.) are not initialized. | The mapping is uninitialized, resulting in a rollback of the calculation with a divide-by-zero error. | Logic should be added to the contract to allow administrators to correctly initialize or update the numElements map each time a new generation is created.
|21|2024-06-12|[2024-05-loop#h-01](https://code4rena.com/reports/2024-05-loop#h-01-availability-of-deposit-invariant-can-be-bypassed)|The state variable totalLpETH is not locked to equal totalSupply. | Pre- and post-operations (sandwich attack) to donate ETH and directly obtain lpETH. | Limit the claimedAmount calculation to only the ETH amount obtained from LRT swaps.
|22|2024-06-17|[2024-04-dyad#h-01](https://code4rena.com/reports/2024-04-dyad#h-01-design-flaw-and-mismanagement-in-vault-licensing-leads-to-double-counting-in-collateral-ratios-and-positions-collateralized-entirely-with-kerosine)|The keroseneVault is not authorized to the KerosineManager. | The attacker registers the same asset to both management systems at the same time, causing the asset to be counted twice. | Manage keroseneVault and regular vault in separate mappings, used for price calculation and authorization management respectively.
|23|2024-06-25|[2024-03-dittoeth#h-04](https://code4rena.com/reports/2024-03-dittoeth#h-04-partially-filled-short-records-created-without-a-short-order-cannot-be-liquidated-and-exited)|After the purchase order is matched, when the ERC quantity is lower than the defined minimum value, the order will not be added to the market for initialization. | A partially filled short record has no associated short order, which makes it impossible for the user to exit the short position or perform liquidation operations. | After the call of matchIncomingSell(), make the Short Record reach the fully filled (SR.FullyFilled) state.
|24|2024-07-25|[2024-04-gondi#h-17](https://code4rena.com/reports/2024-04-gondi#h-17-refinancefulladdnewtranche-reusing-a-lenders-signature-leads-to-unintended-behavior)| A type field is missing in the signature to distinguish different operation types. | The attacker used the signature of refinanceFull() to prepend addNewTranche(), causing the loan amount to be approximately twice the original amount. | Add a type field in the RenegotiationOffer to distinguish different operation types.
|25|2024-07-13|[2024-06-strateg-proleague#h-1](https://github.com/code-423n4/zenith-portfolio/tree/main/reports)| There is a lack of a list of processed tokens to ensure that the same generation of tokens will not be counted multiple times. | The attacker repeatedly calculated the balance of Token B, inflated the total assets, and then obtained more shares at a low price. | Add deduplication logic in the oracleExit() function to ensure that the same generation of coins is not calculated multiple times.
|26|2024-09-13|[2024-09-legion-evm-zenith#h-3](https://github.com/code-423n4/zenith-portfolio/tree/main/reports)| A Boolean flag indicating whether the funds have been withdrawn is missing. | The withdrawCapital() function can be called multiple times until all remaining capital in the contract is withdrawn. | Add a Boolean flag tokensWithdrawn to indicate whether funds have been withdrawn.
|27|2024-10-07|[2024-08-phi#h-04](https://code4rena.com/reports/2024-08-phi#h-04-forced-endtime-extension-in-updateartsettings-allows-attacker-to-mint-more-tokens)|The endTime is incorrectly updated to block.timestamp in updateArtSettings().  | The attacker exploited the extended endTime to repeat the transaction and mint additional tokens. | Separate the update logic for "uri", "soulBounded", and "royalty" config. Additionally, change the ">" to ">=" in the time validation condition.
