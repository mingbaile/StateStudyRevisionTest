## Incorrect Logic Update
Incorrect Logic Update (Conducted State Variable Update with Incorrect Logic, 34.48%)
|Serial number| Reporting time |  Bug link  | Root cause | Exploitation method | Fix strategy  |
|    :---:    |      :---:     |    :---:    |      :---:     |      :---:     |      :---:     |
|1|2021-09-16|[2021-06-pooltogether#h-04](https://code4rena.com/reports/2021-06-pooltogether#h-04-withdraw-timelock-can-be-circumvented)| The time lock mechanism did not take effect as expected, allowing users to bypass the time lock and withdraw funds directly. | The withdrawWithTimelockFrom() function sets incorrect _unlockTimestamps. | The withdrawWithTimelockFrom() function should increment the unlock timestamp by the specified duration.
|2|2021-11-23|[2021-10-mochi#h-11](https://code4rena.com/reports/2021-10-mochi#h-11-treasuryshare-is-overwritten-in-feepoolv0_sharemochi)| The _shareMochi() function incorrectly resets treasuryShare. | VeCRV holders can receive tokens that should have been allocated to treasure multiple times. | Remove the operation that resets treasuryShare.
|3|2022-03-24|[2022-01-behodler#h-04](https://code4rena.com/reports/2022-01-behodler#h-04-logic-error-in-burnflashgovernanceasset-can-cause-locked-assets-to-be-stolen)| Reset the user's pendingFlashDecision to default configuration when processing pending governance decisions. | The attacker repeatedly calls withdrawGovernanceAsset to steal funds. | Properly clear the user's pendingFlashDecision state in the burnFlashGovernanceAsset() function.
|4|2022-07-18|[2022-04-abranft#h-03](https://code4rena.com/reports/2022-04-abranft#h-03-critical-oracle-manipulation-risk-by-lender)| Lenders can replace the Oracle after loan approval. | After the loan is issued, the attacker uses the updateLoanParams() function to maliciously replace the oracle. | Add validation for params.oracle == cur.oracle in the checks.
|5|2023-03-21|[2022-12-gogopool#h-01](https://code4rena.com/reports/2022-12-gogopool#h-01-avax-assigned-high-water-is-updated-incorrectly)| The maximum AVAX allocation per node in the cycle is increased via the increaseAVAXAssignedHighWater() function, rather than being directly updated to the current AVAXAssigned value. | The attacker manipulates AVAX higher than the actual allocation to obtain more rewards. | Change the previous cumulative update method to directly update to the current AVAXAssigned value.
|6|2023-04-05|[2022-07-golom#h-10](https://code4rena.com/reports/2022-07-golom#h-10-upon-changing-of-delegate-votedelegation-updates-both-the-previous-and-the-current-checkpoint)|When updating the voting proxy, both the old and new checkpoints were updated, causing the previous checkpoint to erroneously include the latest changes. | Incorrect vote counting affects the integrity of the voting system. | Modify the "storage checkpoint" to "memory checkpoint" in both the delegate() and removeDelegation() functions.
|7|2023-04-05|[2022-07-golom#h-07](https://code4rena.com/reports/2022-07-golom#h-07-_writecheckpoint-does-not-write-to-storage-on-same-block)| During delegate operations, the "Checkpoint memory oldCheckpoint" in the function is only modified in memory and not written to storage. | The checkpoint is not written correctly, and the user's second delegation operation will not be persisted, resulting in the loss of delegation information. | Change "memory oldCheckpoint" to "storage oldCheckpoint".
|8|2023-04-18|[2022-12-tessera#h-06](https://code4rena.com/reports/2022-12-tessera#h-06-funds-are-permanently-stuck-in-optimisticlistingseaportsol-contract-if-active-proposal-is-executed-after-new-proposal-is-pending)| The propose() function overwrites the hash of the currently active proposal. | When an activated proposal is executed while a new proposal is pending, funds are permanently stuck in the contract. | Add an orderHash field to the Listing struct to ensure active and new proposals maintain distinct hash values.
|9|2023-04-18|[2022-12-tessera#h-03](https://code4rena.com/reports/2022-12-tessera#h-03-groupbuy_verifyunsuccessfulstate-and-_verifysuccessfulstate-both-can-return-true-when-blocktimestamp--poolterminationperiod)|Both _verifyUnsuccessfulState() and _verifySuccessfulState() functions return true for the terminationPeriod timestamp.  | The attacker stole funds by repeatedly claiming already refunded funds. | Change the time comparison condition in the _verifySuccessfulState() function from "<" to "<=".
|10|2023-05-01|[2023-02-malt#h-03](https://code4rena.com/reports/2023-02-malt#h-03-manipulation-of-liveprice-to-receive-defaultincentive-in-2-consecutive-blocks)| Claim rewards when the TWAP falls below the protocol's price threshold. | The attacker received two defaultIncentive rewards through flash loans in two consecutive blocks. | Adjust the reward distribution conditions by adding a cooldown period.
|11|2023-06-23|[2023-05-party#h-01](https://code4rena.com/reports/2023-05-party#h-01-the-distribution-logic-will-be-broken-after-calling-ragequit)| Calculate the allocation ratio for each faction's NFTs based on the current totalVotingPower. | The users’ allocation shares were miscalculated, allowing the attacker to obtain more funds than they deserved by destroying NFTs. | Do not use dynamic totalVotingPower for allocation. Instead, record the initial totalVotingPower at the time of each distribution.
|12|2023-06-29|[2023-05-ajna#h-02](https://code4rena.com/reports/2023-05-ajna#h-02-positionmanagers-moveliquidity-can-set-wrong-deposit-time-and-permanently-freeze-lp-funds-moved)| The depositTime of the target position is set directly to the depositTime of the source position. | If the bankruptcy time of the target bucket is greater than the deposit time of the source location, the liquidity provider's funds will be permanently frozen. | Update the depositTime of the target position to the latest valid deposit time of that position.
|13|2023-08-21|[2023-06-lybra#h-02](https://code4rena.com/reports/2023-06-lybra#h-02-doesnt-calculate-the-current-borrowing-amount-for-the-provider-including-the-providers-borrowed-shares-and-accumulated-fees-due-to-inconsistency-in-collateralratio-calculation)| The liquidation() and rigidRedemption() functions calculate collateralRatio differently. | Bypass the correct mortgage rate calculation by calculating only the principal amount borrowed and ignoring the share of the borrowing and accumulated fees. | Modify the collateralRatio calculation method in the rigidRedemption() function.
|14|2023-09-07|[2023-01-popcorn#h-11](https://code4rena.com/reports/2023-01-popcorn#h-11-protocol-loses-fees-because-highwatermark-is-updated-every-time-someone-deposit-withdraw-mint)| The highWaterMark is updated whenever a user deposits, withdraws, or mints. | The inability to properly track the progress of earnings makes it impossible for the agreement to correctly charge for earnings when they are available. | Adjust the highWaterMark update timing to occur only during initial deposits and after successful fee collections.
|15|2024-12-08|[2024-jul-gemnify-proleague#h-5](https://github.com/code-423n4/zenith-portfolio)|When reducing positions, the amount affecting the pool is incorrectly increased.  | The withdrawal amounts were not properly accounted for, falsely increasing the amounts affecting the pool. | Check whether the user's withdrawn funds are sufficient before updating the affected pool.
|16|2024-09-06|[2023-11-zetachain#h-06](https://code4rena.com/reports/2023-11-zetachain#h-06-zevm-cross-chain-messages-ignore-the-user-specified-message-and-prevent-calling-the-destination-contract)| The user's message field is overwritten with an empty string. | The target contract cannot be called, which makes the cross-chain message function unable to work properly. | Modify the message field as specified by the user.
|17|2024-09-13|[2024-07-traitforge#h-04](https://code4rena.com/reports/2024-07-traitforge#h-04-number-of-entities-in-generation-can-surpass-the-10k-number)| During generation switching, the current generation's counter genMintCount is reset, failing to accurately record the true minting quantity of the previous generation when the next generation begins. | The number of new generations of entities was calculated incorrectly and allowed infinite generations of entities to be created. | Remove the operation that resets genMintCount.
|18|2024-10-07|[2024-08-phi#h-04](https://code4rena.com/reports/2024-08-phi#h-04-forced-endtime-extension-in-updateartsettings-allows-attacker-to-mint-more-tokens)|The endTime is incorrectly updated to block.timestamp in updateArtSettings().  | The attacker exploited the extended endTime to repeat the transaction and mint additional tokens. | Separate the update logic for "uri", "soulBounded", and "royalty" config. Additionally, change the ">" to ">=" in the time validation condition.
|19|2024-10-18|[2024-08-superposition#h-01](https://code4rena.com/reports/2024-08-superposition#h-01-update_emergency_council_7_d_0_c_1_c_58-updates-nft-manager-instead-of-emergency-council)| The update_emergency_council_7_D_0_C_1_C_58() function fails to correctly update the target state (i.e., the emergency_council address) and instead erroneously modifies another administrative role, nft_manager. | An incorrect update to nft_manager caused emergency management to not work properly. | Update the emergency_council address.


### subtype (Improper Call Sequence)
|Serial number| Reporting time |  Bug link  | Root cause | Exploitation method | Fix strategy  |
|    :---:    |      :---:     |    :---:    |      :---:     |      :---:     |      :---:     |
|20|2022-11-29|[2022-09-frax#h-01](https://code4rena.com/reports/2022-09-frax#h-01-wrong-accounting-logic-when-syncrewards-is-called-within-beforewithdraw-makes-withdrawals-impossible)| The syncRewards() function is not called to synchronize rewards before executing withdrawal operations. | An accounting logic error caused the nextRewards calculation to be inflated, resulting in overpayment of rewards. | Call syncRewards() before calling beforeWithdraw().
|21|2023-01-20|[2022-11-stakehouse#h-16](https://code4rena.com/reports/2022-11-stakehouse#h-16-reentrancy-vulnerability-in-giantmevandfeespoolwithdraweth)| beforeTokenTransfer() is called before the ETH transfer occurs. | After receiving ETH, the attacker used the unlocked claimRewards() function to perform multiple transactions, resulting in too many rewards being issued. | Perform the "idleETH -= _amount;" operation after burning the LP tokens.
|22|2023-01-20|[2022-11-stakehouse#h-08](https://code4rena.com/reports/2022-11-stakehouse#h-08-function-withdraweth-from-giantmevandfeespool-can-steal-most-of-eth-because-of-idleeth-is-reduced-before-burning-token)| The idleETH is decremented before LP token burning. | The reward calculation is wrong, and the attacker calls the withdrawETH() function to steal ETH. | Decrement idleETH only after token burning.
|23|2023-03-10|[2023-01-timeswap#h-03](https://code4rena.com/reports/2023-01-timeswap#h-03-the-collect-function-will-always-transfer-zero-fees-losing-_feespositions-without-receiving-fees)| The calculation of variables like long0Fees and long1Fees is executed only after the transferFees() function call. | The incorrect calculation of the long0Fees, long1Fees and other variables used to calculate fees caused the transfer fee to always be zero. | Calculate the actual values of long0Fees, long1Fees, and shortFees before calling transferFees().
|24|2023-04-18|[2022-12-tessera#h-04](https://code4rena.com/reports/2022-12-tessera#h-04-optimisticlistingseaportpropose-sets-pendingbalances-of-newly-added-proposer-instead-of-previous-one)| Update pendingBalances only after new proposal creation. | The old proposer loses the deposit, and the new proposer can repeat the proposal. | Update pendingBalances before calling _setListing().
|25|2023-05-01|[2023-02-malt#h-06](https://code4rena.com/reports/2023-02-malt#h-06-stabilizernodestabilize-uses-stale-globalimpliedcollateralservice-data-which-will-make-stabilize-incorrect)| Call syncGlobalCollateral() at the end of stabilize(). | Using an outdated collateralRatio for stabilization calculations can make stabilization operations inaccurate and may cause tokens to depeg. | Call impliedCollateralService() before stabilize() executes.
|26|2023-05-01|[2023-02-malt#h-05](https://code4rena.com/reports/2023-02-malt#h-05-_distributeprofit-will-use-the-stale-globalicswingtradercollateraldeficitswingtradercollateralratio-which-will-result-in-incorrect-profit-distribution)| The profit distribution ratio is calculated before updating the dependent values. | Using inaccurate values ​​when allocating profits leads to incorrect profit distribution, causing LPs (liquidity providers) to receive too much profit. | Call syncGlobalCollateral() before calling handleProfit().
|27|2023-05-01|[2023-02-malt#h-02](https://code4rena.com/reports/2023-02-malt#h-02-rewardthrottle-if-an-epoch-does-not-have-any-profit-then-there-may-not-be-rewards-for-that-epoch-at-the-start-of-the-next-epoch)| The location of the _fillInEpochGaps() call is incorrect. | fillInEpochGaps() did not correctly calculate and request rewards from overflowPool, resulting in lost rewards for unprofitable epochs. | Remove the call to fillInEpochGaps(). Or, move the call to checkRewardUnderflow() to the beginning of each new epoch. Or, restrict calls to fillInEpochGaps() to administrators only.
|28|2023-06-23|[2023-04-party#h-07](https://code4rena.com/reports/2023-04-party#h-07-initialethcrowdfund--reraiseethcrowdfund-batchcontributefor-function-may-not-refund-eth-which-leads-to-loss-of-funds)| Decrement the ethAvailable before each contributeFor() call. | When a contribution fails, the remaining ETH is not correctly calculated and refunded to the user, resulting in the user losing funds. | Move the ethAvailable decrement operation after the contributeFor() call.
|29|2023-11-29|[2023-07-axelar#h-01](https://code4rena.com/reports/2023-07-axelar#h-01-expressreceivetoken-can-be-abused-using-reentry)| expressReceiveTokenWithData() delays state updates until after token transfers. | Stealing funds in cross-chain transfers using reentry attacks. | Call _setExpressReceiveTokenWithData() in advance.
|30|2023-12-29|[2023-08-dopex#h-05](https://code4rena.com/reports/2023-08-dopex#h-05-users-can-get-immediate-profit-when-deposit-and-redeem-in-perpetualatlanticvaultlp)| Call previewDeposit() before updateFunding(). | The value of the assets calculated at the time of redemption included additional funds for an undeserved profit. | Move the updateFunding() call to before previewDeposit().
|31|2024-05-03|[2024-03-abracadabra-money#h-01](https://code4rena.com/reports/2024-03-abracadabra-money#h-01-anyone-making-use-of-the-magiclps-twap-to-determine-token-prices-will-be-exploitable)| Reserves updates precede TWAP updates. | Manipulate reserve values prior to TWAP updates, manipulate prices and profit on subsequent trades. | Advance the execution position of the _twapUpdate() function.
|32|2024-05-22|[2024-03-revert-lend#h-02](https://code4rena.com/reports/2024-03-revert-lend#h-02-risk-of-reentrancy-onerc721received-function-to-manipulate-collateral-token-configs-shares)|The cleanupLoan() function is called before _updateAndCheckCollateral(). | A reentry attack is utilized to update debt shares multiple times, manipulate borrowing caps, and prevent other users from borrowing. | Call cleanupLoan() after _updateAndCheckCollateral().
|33|2024-07-28|[2024-06-playfi-proleague#h-2](https://github.com/code-423n4/zenith-portfolio)|  Send the referral commission before updating state variables (totalClaimed, totalLicenses). | The attacker used a reentrancy attack to purchase quantities exceeding the permitted limit. | Process referral commission transfers after updating state variables (totalClaimed, totalLicenses).


### subtype (Improper Boundary Condition Handling)
|Serial number| Reporting time |  Bug link  | Root cause | Exploitation method | Fix strategy  |
|    :---:    |      :---:     |    :---:    |      :---:     |      :---:     |      :---:     |
|34|2021-09-17|[2021-08-yield#h-02](https://code4rena.com/reports/2021-08-yield#h-02-erc20rewards-returns-wrong-rewards-if-no-tokens-initially-exist)| The _updateRewardsPerToken function early returns when totalSupply is zero. | When minting for the first time, the user mistakenly received all the rewards from the previous reward period. | Update lastUpdated even when totalSupply is zero.
|35|2022-02-11|[2021-11-streaming#h-08](https://code4rena.com/reports/2021-11-streaming#h-08-tstokens-sometimes-calculated-incorrectly)| ts.tokens == 0 causes ts.lastUpdate to remain unupdated. | Ts.token was miscalculated, resulting in the extraction of more tokens than it should have been. | Update ts.lastUpdate even when ts.tokens is zero.
|36|2022-05-02|[2021-12-defiprotocol#h-01](https://code4rena.com/reports/2021-12-defiprotocol#h-01-wrong-fee-calculation-after-totalsupply-was-0)| lastFee is not updated in the handleFees function when totalSupply is zero. | When the basket is replenished, the cost will be calculated based on the incorrect time difference. | Update lastFee even when totalSupply is zero.
|37|2022-12-22|[2022-10-traderjoe#h-05](https://code4rena.com/reports/2022-10-traderjoe#h-05-attacker-can-steal-entire-reserves-by-abusing-fee-calculation)| Exception handling for the zero address (address(0)) and the contract's own address (address(this)) skips _cacheFees updates for these addresses. | Exploiting faulty accounting logic to bypass proper fee accumulation when collectFees() is called and steal reserve assets. | Modify the skip conditions and add overflow checks.
|38|2023-01-09|[2022-10-juicebox#h-01](https://code4rena.com/reports/2022-10-juicebox#h-01-making-a-payment-to-the-protocol-with-_dontmint-parameter-will-result-in-lost-fund-for-user)| When _dontMint is true, the function immediately returns without incrementing the user's creditsOf balance. | The user's payment amount was not correctly added to the credit balance, resulting in lost funds. | Add an update to creditsOf[_data.beneficiary] before the return statement.
|39|2023-05-01|[2023-02-malt#h-01](https://code4rena.com/reports/2023-02-malt#h-01-rewardthrottlecheckrewardunderflow-might-track-the-cumulative-aprs-wrongly)| The _sendToDistributor() function early returns if amount == 0. | The cumulative APR was not calculated correctly, affecting the target APR calculation in updateDesiredAPR(). | Add conditions and modify the logic in _sendToDistributor() to update the current epoch's cumulative APR with the previous epoch's APR value when the amount is zero.
|40|2024-07-13|[2024-06-strateg-proleague#h-4](https://github.com/code-423n4/zenith-portfolio/tree/main/reports)| lastClaimTotalRewards only updates when feeClaimable is greater than 0. | The attacker transferred the balances of the two tokenIds and stole the rewards from the contract multiple times by repeatedly claiming the rewards. | Update the variables lastClaimTotalRewards and timeClaimed before the feeClaimable check.
